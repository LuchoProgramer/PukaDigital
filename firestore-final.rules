rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // REGLAS FINALES MULTITENANT - USAR DESPUÉS DE LA MIGRACIÓN
    
    // Colección de tenants (solo lectura para usuarios autenticados)
    match /tenants/{tenantId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        isUserTenantAdmin(tenantId, request.auth.uid);
      
      // Usuarios dentro de cada tenant
      match /users/{userId} {
        allow read: if request.auth != null && 
          (request.auth.uid == userId || isUserInTenant(tenantId, request.auth.uid));
        allow write: if request.auth != null && 
          isUserTenantAdmin(tenantId, request.auth.uid);
      }
      
      // Blogs dentro de cada tenant
      match /blogs/{blogId} {
        allow read: if true; // Blogs públicos para lectura
        allow write: if request.auth != null && 
          (isUserTenantAdmin(tenantId, request.auth.uid) || 
           isUserTenantEditor(tenantId, request.auth.uid));
      }
    }
    
    // Colección de usuarios globales (mantener para compatibilidad temporal)
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Colección de blogs globales (solo lectura, mantener para compatibilidad)
    match /blogs/{blogId} {
      allow read: if true;
      allow write: if false; // Deshabilitado después de migración
    }
    
    // Funciones auxiliares
    function isUserInTenant(tenantId, userId) {
      return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(userId));
    }
    
    function isUserTenantAdmin(tenantId, userId) {
      return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(userId)) &&
        get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(userId)).data.role == 'admin';
    }
    
    function isUserTenantEditor(tenantId, userId) {
      return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(userId)) &&
        (get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(userId)).data.role == 'admin' ||
         get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(userId)).data.role == 'editor');
    }
  }
}